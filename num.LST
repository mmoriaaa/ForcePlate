C51 COMPILER V9.53.0.0   NUM                                                               12/29/2018 16:30:00 PAGE 1   


C51 COMPILER V9.53.0.0, COMPILATION OF MODULE NUM
OBJECT MODULE PLACED IN num.OBJ
COMPILER INVOKED BY: F:\Keil_v5\C51\BIN\C51.EXE num.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND TABS(2)

line level    source

   1          /************************************************************************************
   2          *
   3          * 功能说明：数码管的操作函数。
   4          * 作者信息：品诺电子(http://free-design.taobao.com)
   5          *
   6          ************************************************************************************/
   7          #include "stc15f2k60s2.h"
   8          #include "my_type.h"
   9          #include "main.h"
  10          #include "num.h" 
  11          
  12          #define NUM_OE  P47
  13          #define NUM_SER P02
  14          #define NUM_SCK P45   //上升沿数据移位，下降沿不变
  15          #define NUM_RCK P11   //上升沿移位寄存器数据进入数据存储器，下降沿不变
  16          
  17          code u8 numCode[]={//七段数码管显示0到F的编码表
  18            0x3f,0x06,0x5b,0x4f,0x66,0x6d,0x7d,0x07,0x7f,0x6f, /*显示0~9*/
  19            0x77,0x7c,0x39,0x5e,0x79,0x71, /*显示a~f*/
  20            0x00, /*八段全熄灭，显示空，地址0x10*/
  21            0x80, /*显示小数点，地址0x11*/
  22            0x40  /*显示中间横杠，地址0x12*/
  23          };
  24          
  25          static u8 displayNumCode[4]={0,0,0,0};  //全局变量，用于存储数码管的4个显示位的编码
  26          static volatile u8 secondFlag=0;  //每秒置位1次
  27          
  28          /********************************************************************
  29          函数功能：往74HC595芯片的移位寄存器中写入一个bit并移位。
  30          入口参数：b:待写入的bit。
  31          返    回：无。
  32          备    注：无。
  33          ********************************************************************/
  34          void SetOneBit(u8 b)
  35          {
  36   1        NUM_SCK=0;    //下降沿不变
  37   1        //Delay(1);
  38   1        NUM_SER=b;    //串行输入
  39   1        //Delay(1);
  40   1        NUM_SCK=1;    //上升沿数据移位
  41   1        //Delay(1);
  42   1      }
  43          /**///////////////////////Pino Electronics////////////////////////**/
  44          
  45          /********************************************************************
  46          函数功能：将位选和显示码值写入74HC595，刷新数码管的位选和显示值。
  47          入口参数：无。
  48          返    回：无。
  49          备    注：5ms左右刷新一次，若刷新太慢了人眼会感觉出数码管的闪烁。
  50          ********************************************************************/
  51          void RefreshNumDisplay(void)
  52          {
  53   1        static u8 curCount=0;//表示当前刷新的是第几个位，数码管共有4个显示位
  54   1        u8 curDisplayNumCode;
  55   1        u8 i;
C51 COMPILER V9.53.0.0   NUM                                                               12/29/2018 16:30:00 PAGE 2   

  56   1      
  57   1        NUM_RCK=0;      //上升沿移位寄存器数据进入数据存储器，下降沿不变
  58   1        curCount++;     //数码管共有4个显示位，故显示完一个数，数值加1
  59   1        if (curCount==4)  //超过3则重新开始显示第0个
  60   1          curCount=0;
  61   1        for(i=0;i<4;i++){ //选择刷新数码管的第i位
  62   2          if(i==curCount)
  63   2            SetOneBit(0);
  64   2          else
  65   2            SetOneBit(1);
  66   2        }
  67   1        curDisplayNumCode=displayNumCode[curCount]; //取当前刷新的那个位的编码值
  68   1        for(i=0;i<8;i++){ //7段数码管加小数点，故有8位
  69   2          SetOneBit((curDisplayNumCode&0x80)>>7);   //将编码值的每一位移入74HC595的移位寄存器
  70   2          curDisplayNumCode<<=1;
  71   2        }
  72   1        NUM_RCK=1;  //移位寄存器的数据进入显示存储器
  73   1        //Delay(1);
  74   1        NUM_OE=0;   //使能显示，至此完成显示一个位
  75   1      }
  76          /**///////////////////////Pino Electronics////////////////////////**/
  77          
  78          /********************************************************************
  79          函数功能：将传进的参数number转换成十进制数，写入全局变量displayNum，用于数码管显示。
  80          入口参数：number:要在数码管上显示的数值。
  81          返    回：无。
  82          备    注：无。
  83          ********************************************************************/
  84          void SetNumDisplayDecimal(u16 number)
  85          {
  86   1        u8 index[4];
  87   1        s8 i;
  88   1        
  89   1        index[3]=(number/1000);
  90   1        index[2]=(number%1000/100);
  91   1        index[1]=(number%100/10);
  92   1        index[0]=(number%10);
  93   1        for(i=3;i>=1;i--){  //高位是0时，0不显示出来，比如2不能显示成0002
  94   2          if(index[i]==0)
  95   2            index[i]=0x10;  //根据numCode[]，地址为0x10时显示空白
  96   2          else
  97   2            break;
  98   2        }
  99   1        for(i=3;i>=0;i--){
 100   2          if(number>9999)   //大于9999的数显示为横杠
 101   2            displayNumCode[i]=numCode[0x12];  //根据numCode[]，地址为0x12时显示横杠
 102   2          else
 103   2            displayNumCode[i]=numCode[index[i]];
 104   2        }
 105   1      }
 106          /**///////////////////////Pino Electronics////////////////////////**/
 107          
 108          /********************************************************************
 109          函数功能：将传进的参数number转换成十六进制数，写入全局变量displayNumCode，
 110                用于数码管显示，显示一个无符号char型，即：两位十六进制数。
 111          入口参数：number:要在数码管上显示的数值。
 112          返    回：无。
 113          备    注：无。
 114          ********************************************************************/
 115          void SetNumDisplayHex8(u8 number)
 116          {
 117   1        unsigned char index[4];
C51 COMPILER V9.53.0.0   NUM                                                               12/29/2018 16:30:00 PAGE 3   

 118   1      
 119   1        index[3]=0x10;  //根据numCode[]，地址为0x10时显示空白
 120   1        index[2]=0x10;
 121   1        index[1]=((number>>4)&0x0f);
 122   1        index[0]=(number&0x0f);
 123   1      
 124   1        displayNumCode[3]=numCode[index[3]];  //当前位的数值的编码值
 125   1        displayNumCode[2]=numCode[index[2]];  
 126   1        displayNumCode[1]=numCode[index[1]];
 127   1        displayNumCode[0]=numCode[index[0]];
 128   1      }
 129          /**///////////////////////Pino Electronics////////////////////////**/
 130          
 131          /********************************************************************
 132          函数功能：将传进的参数number转换成十六进制数，写入全局变量displayNumCode，
 133                用于数码管显示，显示一个无符号int型，即：四位十六进制数。
 134          入口参数：number:要在数码管上显示的数值。
 135          返    回：无。
 136          备    注：无。
 137          ********************************************************************/
 138          void SetNumDisplayHex16(u16 number)
 139          {
 140   1        unsigned char index[4];
 141   1      
 142   1        index[3]=(number>>12);
 143   1        index[2]=((number>>8)&0x000f);
 144   1        index[1]=((number>>4)&0x000f);
 145   1        index[0]=(number&0x000f);
 146   1      
 147   1        displayNumCode[3]=numCode[index[3]];  //当前位的数值的编码值
 148   1        displayNumCode[2]=numCode[index[2]];  
 149   1        displayNumCode[1]=numCode[index[1]];
 150   1        displayNumCode[0]=numCode[index[0]];
 151   1      }
 152          /**///////////////////////Pino Electronics////////////////////////**/
 153          
 154          /********************************************************************
 155          函数功能：数码管显示空白。
 156          入口参数：无。
 157          返    回：无。
 158          备    注：无。
 159          ********************************************************************/
 160          void SetNumDisplayBlank(void)
 161          {
 162   1        displayNumCode[3]=0;  
 163   1        displayNumCode[2]=0;  
 164   1        displayNumCode[1]=0;
 165   1        displayNumCode[0]=0;
 166   1      }
 167          /**///////////////////////Pino Electronics////////////////////////**/
 168          
 169          /********************************************************************
 170          函数功能：数码管当前显示的内容上增加小数点。
 171          入口参数：u8 x:要增加小数点的位置，取0~3。
 172          返    回：无。
 173          备    注：无。
 174          ********************************************************************/
 175          void SetNumDisplayDot(u8 i)
 176          {
 177   1        if(i>3)//大于3则参数错误，返回
 178   1          return;
 179   1        displayNumCode[i]|=numCode[0x11];//根据numCode[]，地址为0x11时显示小数点
C51 COMPILER V9.53.0.0   NUM                                                               12/29/2018 16:30:00 PAGE 4   

 180   1      }
 181          /**///////////////////////Pino Electronics////////////////////////**/
 182          
 183          /********************************************************************
 184          函数功能：初始化定时器0，每5ms产生一个中断。
 185          入口参数：无。
 186          返    回：无。
 187          备    注：无。
 188          ********************************************************************/
 189          void InitTimer0(void)
 190          {
 191   1        
 192   1        //AUXR|=0x80;   //设置定时器0为1T模式，默认为12T模式
 193   1        TMOD&=(~0x03);  //设置Timer0工作在模式0(16位自动重载模式)
 194   1      
 195   1        /*系统时钟选择为22.1184M时， 重载值的计算如下：   
 196   1        22118400/12分频/200=9216，即每计数9216耗时为5ms。*/ 
 197   1        TH0 = (65536-SYSCLK/12/200)>>8;   //初始化Timer0重载值
 198   1        TL0 = (65536-SYSCLK/12/200);    //初始化Timer0重载值
 199   1        
 200   1        ET0=1;      //Timer0中断使能
 201   1        TR0 = 1;    //Timer0开启
 202   1      }
 203          /**///////////////////////Pino Electronics////////////////////////**/
 204          
 205          /********************************************************************
 206          函数功能：定时器0的中断服务程序。
 207          入口参数：无。
 208          返    回：无。
 209          备    注：中断标志位自动清除。
 210          ********************************************************************/
 211          void Timer0ISR(void) interrupt 1
 212          {   
 213   1        static u16 count=0;
 214   1        count++;
 215   1        RefreshNumDisplay();  //每5ms刷新一次数码管显示
 216   1        if(count==200){   //5ms一次中断，接收到200次中断即为1秒
 217   2          count=0;
 218   2          secondFlag=1;
 219   2        }
 220   1      }
 221          /**///////////////////////Pino Electronics////////////////////////**/
 222          
 223          /********************************************************************
 224          函数功能：查询secondFlag标志位。
 225          入口参数：无。
 226          返    回：u8:标志位有效，则返回1，否则返回0。
 227          备    注：无。
 228          ********************************************************************/
 229           u8 GetSecondFlag(void)
 230          {
 231   1        if(secondFlag){
 232   2          secondFlag=0;//清除标志位
 233   2          return 1;
 234   2        }else{
 235   2          return 0;
 236   2        }
 237   1      }
 238          /**///////////////////////Pino Electronics////////////////////////**/
 239          


C51 COMPILER V9.53.0.0   NUM                                                               12/29/2018 16:30:00 PAGE 5   

MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    421    ----
   CONSTANT SIZE    =     19    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      8      12
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
