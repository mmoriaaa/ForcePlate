C51 COMPILER V9.53.0.0   I2C1                                                              12/29/2018 16:30:00 PAGE 1   


C51 COMPILER V9.53.0.0, COMPILATION OF MODULE I2C1
OBJECT MODULE PLACED IN i2c1.OBJ
COMPILER INVOKED BY: F:\Keil_v5\C51\BIN\C51.EXE i2c1.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND TABS(2)

line level    source

   1          /************************************************************************************
   2          *
   3          * 功能说明：本文件提供了用普通IO端口模拟I2C总线行为的函数集合。
   4          * 作者信息：品诺电子(http://free-design.taobao.com)
   5          *
   6          ************************************************************************************/
   7          #include "stc15f2k60s2.h"
   8          #include "i2c1.h"
   9          
  10          #define PCF8563_WRITE_ADDR 0xA2 //PCF8563的IIC写地址
  11          /* 定义I2C总线连接的GPIO端口, 只需要修改下面宏定义即可改变SCL和SDA的引脚定义 */
  12          #define I2C_SCL   P43     /* 连接到SCL时钟线的GPIO */
  13          #define I2C_SDA   P44     /* 连接到SDA数据线的GPIO */
  14          
  15          /* 定义读写SCL和SDA的宏，增加代码的可移植性和可阅读性 */
  16          #define I2C_SCL_1()     I2C_SCL=1   /* SCL = 1 */
  17          #define I2C_SCL_0()     I2C_SCL=0   /* SCL = 0 */
  18            
  19          #define I2C_SDA_1()     I2C_SDA=1   /* SDA = 1 */
  20          #define I2C_SDA_0()     I2C_SDA=0   /* SDA = 0 */
  21            
  22          #define I2C_SDA_READ()  I2C_SDA     /* 读SDA线状态 */
  23          
  24          
  25          /********************************************************************
  26          函数功能：I2C总线位延迟函数，总线频率最快400KHz。
  27          入口参数：无。
  28          返    回：无。
  29          备    注：无。
  30          ********************************************************************/
  31          void I2CDelay(void)//延时4us，误差 -0.021412037037us
  32          {
  33   1          u8 a;
  34   1          for(a=19;a>0;a--);
  35   1      }
  36          /**///////////////////////Pino Electronics////////////////////////**/
  37          
  38          /********************************************************************
  39          函数功能：I2C总线初始化。
  40          入口参数：无。
  41          返    回：无。
  42          备    注：无。
  43          ********************************************************************/
  44          void I2CInit(void)
  45          {
  46   1          I2CStop();
  47   1      }
  48          /**///////////////////////Pino Electronics////////////////////////**/
  49          
  50          /********************************************************************
  51          函数功能：I2C开始信号。
  52          入口参数：无。
  53          返    回：无。
  54          备    注：无。
  55          ********************************************************************/
C51 COMPILER V9.53.0.0   I2C1                                                              12/29/2018 16:30:00 PAGE 2   

  56          void I2CStart(void)
  57          {
  58   1        I2C_SDA_1();
  59   1        I2C_SCL_1();
  60   1        I2CDelay();
  61   1        I2C_SDA_0();
  62   1        I2CDelay();
  63   1        I2C_SCL_0();
  64   1        I2CDelay();
  65   1      }
  66          /**///////////////////////Pino Electronics////////////////////////**/
  67          
  68          /********************************************************************
  69          函数功能：I2C结束信号。
  70          入口参数：无。
  71          返    回：无。
  72          备    注：无。
  73          ********************************************************************/
  74          void I2CStop(void)
  75          {
  76   1        I2C_SDA_0();
  77   1        I2C_SCL_1();
  78   1        I2CDelay();
  79   1        I2C_SDA_1();
  80   1        I2CDelay();
  81   1        I2C_SCL_0();
  82   1        I2CDelay();
  83   1      }
  84          /**///////////////////////Pino Electronics////////////////////////**/
  85          
  86          /********************************************************************
  87          函数功能：I2C应答信号。
  88          入口参数：无。
  89          返    回：无。
  90          备    注：无。
  91          ********************************************************************/
  92          void I2CAck(void)
  93          {
  94   1        I2C_SDA_0();
  95   1        I2C_SCL_1();
  96   1        I2CDelay();
  97   1        I2C_SCL_0();
  98   1        I2CDelay();
  99   1        I2C_SDA_1();    //因为引脚配置为漏极开路加上拉电阻
 100   1        I2CDelay();//最后应该保持数据线在高电平状态，使总线上其它器件可以进行数据发送
 101   1      }
 102          /**///////////////////////Pino Electronics////////////////////////**/
 103          
 104          /********************************************************************
 105          函数功能：I2C非应答信号。
 106          入口参数：无。
 107          返    回：无。
 108          备    注：无。
 109          ********************************************************************/ 
 110          void I2CNoAck(void)
 111          {
 112   1        I2C_SDA_1();
 113   1        I2C_SCL_1();
 114   1        I2CDelay();
 115   1        I2C_SCL_0();
 116   1        I2CDelay();
 117   1      }
C51 COMPILER V9.53.0.0   I2C1                                                              12/29/2018 16:30:00 PAGE 3   

 118          /**///////////////////////Pino Electronics////////////////////////**/
 119          
 120          /********************************************************************
 121          函数功能：I2C等待应答信号。
 122          入口参数：无。
 123          返    回：无。
 124          备    注：无。
 125          ********************************************************************/
 126          u8 I2CWaitAck(void)
 127          {
 128   1        u8 ack=0;
 129   1        I2C_SCL_1();
 130   1        I2CDelay();
 131   1        if(I2C_SDA_READ())
 132   1          ack=1;
 133   1        I2C_SCL_0();
 134   1        I2CDelay();
 135   1        return ack;
 136   1      }
 137          /**///////////////////////Pino Electronics////////////////////////**/
 138          
 139          /********************************************************************
 140          函数功能：在I2C总线上，写入一个字节。
 141          入口参数：dat:要写入的字节。
 142          返    回：无。
 143          备    注：无。
 144          ********************************************************************/
 145          void I2CWriteByte(u8 dat)
 146          {
 147   1        u8 i;
 148   1        for(i=0;i<8;i++){
 149   2          if(dat&0x80)
 150   2            I2C_SDA_1();
 151   2          else
 152   2            I2C_SDA_0();
 153   2          I2C_SCL_1();
 154   2          I2CDelay();
 155   2          I2C_SCL_0();
 156   2          I2CDelay();
 157   2          dat<<=1;
 158   2        }
 159   1        I2C_SDA_1();//最后应该保持数据线在高电平状态
 160   1        I2CDelay();
 161   1      }
 162          /**///////////////////////Pino Electronics////////////////////////**/
 163          
 164          /********************************************************************
 165          函数功能：在I2C总线上，读取一个字节。
 166          入口参数：无。
 167          返    回：读取的字节。
 168          备    注：无。
 169          ********************************************************************/
 170          u8 I2CReadByte(void)
 171          {
 172   1        u8 i,dat;
 173   1        for(i=0;i<8;i++){
 174   2          I2C_SCL_1();
 175   2          I2CDelay();
 176   2          dat<<=1;  
 177   2          if (I2C_SDA_READ())
 178   2            dat|=0x01;  
 179   2          I2C_SCL_0();
C51 COMPILER V9.53.0.0   I2C1                                                              12/29/2018 16:30:00 PAGE 4   

 180   2          I2CDelay();
 181   2        }
 182   1        return dat;
 183   1      }
 184          /**///////////////////////Pino Electronics////////////////////////**/
 185          
 186          /********************************************************************
 187          函数功能：往I2C总线上写入设备地址和16bit的寄存器地址。
 188          入口参数：deviceWriteAddr: 设备的I2C写地址；
 189                registerAddr: 16bit的设备寄存器地址；
 190          返    回：无。
 191          备    注：如AT24C64的寄存器地址是16bit的。
 192          ********************************************************************/
 193          void I2CWriteAddr16(u8 deviceWriteAddr,u16 registerAddr)
 194          {
 195   1        u8 tmp;
 196   1        I2CStart();
 197   1        I2CWriteByte(deviceWriteAddr);  //设备写地址
 198   1        I2CWaitAck();
 199   1        tmp=(registerAddr>>8);    //先写高8位地址
 200   1        I2CWriteByte(tmp);      
 201   1        I2CWaitAck();
 202   1        tmp=(registerAddr&0x00ff);      //再写低8位地址
 203   1        I2CWriteByte(tmp);      
 204   1        I2CWaitAck();
 205   1      }
 206          /**///////////////////////Pino Electronics////////////////////////**/
 207          
 208          /********************************************************************
 209          函数功能：往I2C总线上写入设备地址和8bit的寄存器地址。
 210          入口参数：deviceWriteAddr: 设备的I2C写地址；
 211                registerAddr: 8bit的设备寄存器地址；
 212          返    回：无。
 213          备    注：如PCF8563的寄存器地址是8bit的。
 214          ********************************************************************/
 215          void I2CWriteAddr8(u8 deviceWriteAddr,u8 registerAddr)
 216          {
 217   1        I2CStart();
 218   1        I2CWriteByte(deviceWriteAddr);  //设备写地址
 219   1        I2CWaitAck();
 220   1        I2CWriteByte(registerAddr);     
 221   1        I2CWaitAck();
 222   1      }
 223          /**///////////////////////Pino Electronics////////////////////////**/
 224          
 225          /********************************************************************
 226          函数功能：往I2C总线上给定的设备地址和16bit的寄存器地址写入一个BYTE数据。
 227          入口参数：deviceWriteAddr: 设备的I2C写地址；
 228                registerAddr: 16bit的设备寄存器地址；
 229                dat: 要写入的一个BYTE数据
 230          返    回：无。
 231          备    注：如AT24C64的寄存器地址是16bit的。
 232          ********************************************************************/
 233          void I2CWriteByteToDevice16(u8 deviceWriteAddr,u16 registerAddr,u8 dat)
 234          {
 235   1        I2CWriteAddr16(deviceWriteAddr,registerAddr);
 236   1        I2CWriteByte(dat);
 237   1        I2CWaitAck();
 238   1        I2CStop();
 239   1      }
 240          /**///////////////////////Pino Electronics////////////////////////**/
 241          
C51 COMPILER V9.53.0.0   I2C1                                                              12/29/2018 16:30:00 PAGE 5   

 242          /********************************************************************
 243          函数功能：往I2C总线上给定的设备地址和8bit的寄存器地址写入一个BYTE数据。
 244          入口参数：deviceWriteAddr: 设备的I2C写地址；
 245                registerAddr: 8bit的设备寄存器地址；
 246                dat: 要写入的一个BYTE数据
 247          返    回：无。
 248          备    注：如PCF8563的寄存器地址是8bit的。
 249          ********************************************************************/
 250          void I2CWriteByteToDevice8(u8 deviceWriteAddr,u8 registerAddr,u8 dat)
 251          {
 252   1        I2CWriteAddr8(deviceWriteAddr,registerAddr);
 253   1        I2CWriteByte(dat);
 254   1        I2CWaitAck();
 255   1        I2CStop();
 256   1      }
 257          /**///////////////////////Pino Electronics////////////////////////**/
 258          
 259          /********************************************************************
 260          函数功能：从I2C总线上给定的设备地址和16bit的寄存器地址读取一个BYTE数据。
 261          入口参数：deviceWriteAddr: 设备的I2C写地址；
 262                registerAddr: 16bit的设备寄存器地址；
 263          返    回：读取的字节。
 264          备    注：如AT24C64的寄存器地址是16bit的。
 265          ********************************************************************/
 266          u8 I2CReadByteFromDevice16(u8 deviceWriteAddr,u16 registerAddr)
 267          {
 268   1        u8 dat;
 269   1        I2CWriteAddr16(deviceWriteAddr,registerAddr);
 270   1        I2CStart();
 271   1        I2CWriteByte(deviceWriteAddr|0x01); //修改设备地址的读写标志位
 272   1        I2CWaitAck();
 273   1        dat=I2CReadByte();
 274   1        I2CNoAck();
 275   1        I2CStop();
 276   1        return dat;
 277   1      }
 278          /**///////////////////////Pino Electronics////////////////////////**/
 279          
 280          /********************************************************************
 281          函数功能：从I2C总线上给定的设备地址和8bit的寄存器地址读取一个BYTE数据。
 282          入口参数：deviceWriteAddr: 设备的I2C写地址；
 283                registerAddr: 8bit的设备寄存器地址；
 284          返    回：读取的字节。
 285          备    注：如PCF8563的寄存器地址是8bit的。
 286          ********************************************************************/
 287          u8 I2CReadByteFromDevice8(u8 deviceWriteAddr,u8 registerAddr)
 288          {
 289   1        u8 dat;
 290   1        I2CWriteAddr8(deviceWriteAddr,registerAddr);
 291   1        I2CStart();
 292   1        I2CWriteByte(deviceWriteAddr|0x01); //修改设备地址的读写标志位
 293   1        I2CWaitAck();
 294   1        dat=I2CReadByte();
 295   1        I2CNoAck();
 296   1        I2CStop();
 297   1        return dat;
 298   1      }
 299          /**///////////////////////Pino Electronics////////////////////////**/
 300          


MODULE INFORMATION:   STATIC OVERLAYABLE
C51 COMPILER V9.53.0.0   I2C1                                                              12/29/2018 16:30:00 PAGE 6   

   CODE SIZE        =    272    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
